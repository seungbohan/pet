<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="naver-site-verification" content="878c81293bdfaf1f57c9394918d51e5100b6899e" />
    <title>ë§ˆì´í˜ì´ì§€</title>
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/mypage.css}" />
</head>
<body>
<div class="main-container">
    <!-- í—¤ë” -->
    <div class="header">
        <div class="user-avatar">ğŸ‘¤</div>
        <h1>ë§ˆì´í˜ì´ì§€</h1>
        <p>íšŒì› ì •ë³´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>

    <!-- í¼ ì»¨í…Œì´ë„ˆ -->
    <div class="form-container">
        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="info-card">
            <h3>ğŸ“ íšŒì›ì •ë³´ ìˆ˜ì •</h3>
            <p>ì´ë¦„ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="messageArea"></div>

        <!-- í¼ -->
        <form id="userForm">
            <div class="form-group">
                <label for="name">ì´ë¦„</label>
                <input type="text" name="name" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>

            <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <input type="text" name="email" id="email" readonly placeholder="ì´ë©”ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..." />
            </div>

            <div class="divider"></div>

            <div class="button-group">
                <button type="button" id="modify" class="btn btn-primary">
                    ìˆ˜ì •í•˜ê¸°
                </button>
                <button type="button" id="delete" class="btn btn-danger">
                    íšŒì›íƒˆí‡´
                </button>
            </div>
        </form>

        <!-- íƒˆí‡´ ì•ˆë‚´ -->
        <div class="info-card" style="margin-top: 30px; border-left-color: #dc3545; background: #fff5f5;">
            <h3>âš ï¸ íšŒì›íƒˆí‡´ ì•ˆë‚´</h3>
            <p>íƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•´ ì£¼ì„¸ìš”.</p>
        </div>
    </div>
</div>

<script>
    console.log("âœ… JS ë¡œë”© í™•ì¸ë¨");
    const token = localStorage.getItem("token");
    console.log("ğŸ“¦ í† í°:", token);

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'success') {
        const messageArea = document.getElementById('messageArea');
        messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;

        // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
        setTimeout(() => {
            messageArea.innerHTML = '';
        }, 3000);
    }

    // ë²„íŠ¼ ë¡œë”© ìƒíƒœ ê´€ë¦¬
    function setButtonLoading(button, loading) {
        if (loading) {
            button.classList.add('loading');
            button.disabled = true;
        } else {
            button.classList.remove('loading');
            button.disabled = false;
        }
    }

    document.addEventListener("DOMContentLoaded", async function() {
        if (!token) {
            showMessage("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤", 'error');
            setTimeout(() => {
                window.location.href = "/join/login";
            }, 1500);
            return;
        }

        try {
            const response = await fetch("/api/mypage/user", {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (!response.ok) {
                throw new Error("ì¸ì¦ ì‹¤íŒ¨");
            }

            const data = await response.json();

            document.querySelector("input[name=email]").value = data.email;
            document.querySelector("input[name=name]").value = data.name;

            // ì´ë¦„ì˜ ì²« ê¸€ìë¡œ ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
            if (data.name) {
                document.querySelector('.user-avatar').textContent = data.name.charAt(0).toUpperCase();
            }

            showMessage("íšŒì›ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤", 'success');

        } catch (e) {
            showMessage("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤", 'error');
            localStorage.removeItem("token");
            setTimeout(() => {
                window.location.href = "/join/login";
            }, 2000);
        }
    });

    document.getElementById("modify").addEventListener("click", async function () {
        const modifyBtn = this;
        const email = document.querySelector("input[name=email]").value;
        const name = document.querySelector("input[name=name]").value.trim();

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!name) {
            showMessage("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”", 'error');
            document.querySelector("input[name=name]").focus();
            return;
        }

        if (name.length < 2) {
            showMessage("ì´ë¦„ì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”", 'error');
            document.querySelector("input[name=name]").focus();
            return;
        }

        setButtonLoading(modifyBtn, true);

        try {
            const response = await fetch("/api/mypage/user/modify", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "content-type": "application/json"
                },
                body: JSON.stringify({
                    email,
                    name
                })
            });

            if (!response.ok) {
                throw new Error("ìš”ì²­ ì‹¤íŒ¨");
            }

            showMessage("íšŒì›ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!", 'success');

            // ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸
            document.querySelector('.user-avatar').textContent = name.charAt(0).toUpperCase();

            setTimeout(() => location.reload(), 1500);

        } catch (e) {
            showMessage("ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'error');
            console.error("ìˆ˜ì • ì˜¤ë¥˜:", e);
        } finally {
            setButtonLoading(modifyBtn, false);
        }
    });

    document.getElementById("delete").addEventListener("click", async function () {
        const deleteBtn = this;

        const confirmed = confirm("ì •ë§ë¡œ íšŒì›ì„ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\níƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!confirmed) {
            return;
        }

        const doubleConfirmed = confirm("ì •ë§ë¡œ í™•ì‹¤í•˜ì‹ ê°€ìš”?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!doubleConfirmed) {
            return;
        }

        setButtonLoading(deleteBtn, true);

        try {
            const response = await fetch("/api/mypage/user/delete", {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token,
                }
            });

            if (!response.ok) {
                throw new Error("ìš”ì²­ ì‹¤íŒ¨");
            }

            showMessage("íšŒì›íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", 'success');
            localStorage.removeItem("token");

            setTimeout(() => {
                window.location.href = "/join/login";
            }, 2000);

        } catch (e) {
            showMessage("íƒˆí‡´ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", 'error');
            console.error("íƒˆí‡´ ì˜¤ë¥˜:", e);
        } finally {
            setButtonLoading(deleteBtn, false);
        }
    });

    // ì—”í„°í‚¤ë¡œ ìˆ˜ì •í•˜ê¸°
    document.querySelector("input[name=name]").addEventListener("keypress", function(e) {
        if (e.key === 'Enter') {
            document.getElementById("modify").click();
        }
    });

    // ì…ë ¥ í•„ë“œ ì• ë‹ˆë©”ì´ì…˜
    document.querySelectorAll('.form-group input').forEach(input => {
        input.addEventListener('focus', function() {
            this.parentElement.classList.add('focused');
        });

        input.addEventListener('blur', function() {
            this.parentElement.classList.remove('focused');
        });
    });
</script>
</body>
</html>